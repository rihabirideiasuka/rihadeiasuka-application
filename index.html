<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#ff1493" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="あすか申込" />
  <meta name="robots" content="noindex, nofollow" />

  <!-- PWA -->
  <link rel="manifest" href="./manifest.webmanifest?v=6" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icon-180.png?v=6" />
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32.png?v=6" />
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16.png?v=6" />

  <title>リハビリデイあすか見学申込 – 起動</title>

  <!-- JS無効時のフォールバック -->
  <noscript>
    <meta http-equiv="refresh"
          content="0; url=https://script.google.com/macros/s/AKfycbxL4mjOFHXKNZVpdEnz_ge6A9AhWZj6VgOO9ln20MQfUiVaY8uyZRJv0T8BN6YISe5N/exec">
  </noscript>

  <style>
    :root{--bg:#f9f5ee;--fg:#2a2a2a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif}
    .wrap{max-width:680px;margin:12vh auto;padding:24px}
    .card{background:#fff;border:1px solid #e6dfd2;border-radius:16px;padding:28px;box-shadow:0 6px 24px rgba(0,0,0,.06)}
    .muted{color:#6b6b6b}
    .btn{display:inline-block;padding:10px 14px;border-radius:12px;background:#ff1493;color:#fff;text-decoration:none;font-weight:700}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 style="margin:0 0 8px">起動中…</h1>
      <p class="muted" id="msg">自動でアプリへ移動します。開かない場合は下のボタンを押してください。</p>
      <p><a id="fallback" href="#" class="btn">今すぐ開く</a></p>
      <p class="muted" style="font-size:12px;margin-top:16px">
        ※ ホーム追加・オフライン対応は <a href="./install.html">インストール手順</a> を参照。
      </p>
    </div>
  </div>

  <script>
    // ---- あなたの本番 GAS の /exec を設定 ----
    const DEFAULT_GAS_URL = "https://script.google.com/macros/s/AKfycbxL4mjOFHXKNZVpdEnz_ge6A9AhWZj6VgOO9ln20MQfUiVaY8uyZRJv0T8BN6YISe5N/exec";
    // -----------------------------------------

    // SWは“先に”登録しておく（redirectと同時進行でOK）
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js?v=6', { scope: './' }).catch(()=>{});
    }

    const cur = new URL(location.href);
    const params = cur.searchParams;

    const stay        = params.has('stay');      // stay=1 なら自動転送しない
    const appOverride = params.get('app');       // 一時上書き → 永続化
    const clearApp    = params.has('clear_app'); // 既存上書きを消す

    if (clearApp) localStorage.removeItem('GAS_URL');
    if (appOverride) localStorage.setItem('GAS_URL', appOverride);

    const saved = localStorage.getItem('GAS_URL');
    const targetBase = saved || DEFAULT_GAS_URL;

    const out = new URL(targetBase);
    // index.html に付いてきたクエリはそのまま付け替え（管理系は除外）
    params.forEach((v,k)=>{
      if (k==='stay' || k==='app' || k==='clear_app') return;
      out.searchParams.append(k, v);
    });
    const outHref = out.toString() + (location.hash || '');

    document.getElementById('fallback').href = outHref;

    if (!stay) {
      // 戻る履歴を汚さない
      location.replace(outHref);
    }
  </script>
</body>
</html>

